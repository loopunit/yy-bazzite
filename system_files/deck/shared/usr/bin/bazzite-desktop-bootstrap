#!/bin/bash

# Modified from:
# https://gitlab.com/evlaV/steamdeck-kde-presets/-/blob/master/usr/bin/jupiter-plasma-bootstrap?ref_type=heads

set -eo pipefail

SYS_ID="$(/usr/libexec/hwsupport/sysid)"
IMAGE_INFO="/usr/share/ublue-os/image-info.json"
BASE_IMAGE_NAME=$(jq -r '."base-image-name"' < $IMAGE_INFO)

if [[ "${XDG_SESSION_TYPE}" = "wayland" ]]; then
  mkdir -p "$HOME/.config/bazzite/fixups" 2>/dev/null
  # Set scale on GNOME desktops, rotation tends to work without issue.
  if [ ! -f "$HOME/.config/bazzite/fixups/scaling_fixup" ]; then
    if /usr/libexec/hwsupport/needs-100-scale; then
      gnome-randr modify eDP --scale 1 \
        || gnome-randr modify eDP-1 --scale 1 \
        || true
    elif /usr/libexec/hwsupport/needs-200-scale; then
      gnome-randr modify eDP --scale 2 \
        || gnome-randr modify eDP-1 --scale 2 \
        || true
    fi
    touch "$HOME/.config/bazzite/fixups/scaling_fixup"
  fi
fi
